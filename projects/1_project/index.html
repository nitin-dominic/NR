<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Project 1 | Welcome to my webpage!</title> <meta name="author" content="Nitin Rai"> <meta name="description" content="A project that uses Python with " arcpy library> <link rel="stylesheet" href="/NR/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/NR/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/NR/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/NR/assets/img/nrf.svg?021de8303a2543f1b01fc32e747c6959"> <link rel="stylesheet" href="/NR/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nitin-dominic.github.io/NR/NR/projects/1_project/"> <link rel="stylesheet" href="/NR/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/NR/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/NR/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/NR/">Welcome to my webpage!</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/NR/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/NR/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/NR/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/NR/blog/">Blogs</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Project 1</h1> <p class="post-description">A project that uses Python with "arcpy" library</p> </header> <article> <h1 id="automating-development-of-weed-prescription-map-using-arcpy-and-python">Automating development of weed prescription map using Arcpy and Python</h1> <p><b>Rai, N</b> &amp; Flores, P</p> <h3 id="background">Background</h3> <p>This algorithm imports <a href="https://pro.arcgis.com/en/pro-app/latest/arcpy/get-started/a-quick-tour-of-arcpy.htm" rel="external nofollow noopener" target="_blank">ArcPy</a>, and <a href="https://rasterio.readthedocs.io/en/stable/index.html" rel="external nofollow noopener" target="_blank">Rasterio</a> packages in Python (Jupyter notebook) to create a weed prescription map. A feature to calculate Excess Green and four different VIs, namely, Normalised Difference Vegetation Index (NDVI), Normalized Difference Red Edge Index (NDRE), Soil Adjusted Vegetation Index (SAVI), and Optimized Soil Adjusted Vegetation Index (OSAVI) can also be calculated and exported to local drive using the same script. The script accepts a multispectral or an RGB imagery. Based on band count, it calculates the required indices. After indices calculation, it also performs image sharpening and thresholding, thereby converting the whole image into a binary one. After that it converts objects within the image to polygons and performs weed identification while creating a weed map using <a href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/data-management/create-fishnet.htm" rel="external nofollow noopener" target="_blank">Fishnet Grid</a> technique. Full Python code to automate the process can be found <a href="https://github.com/nitin-dominic/Automating-development-of-weed-prescription-map-using-Arcpy-and-Python/blob/main/WeedMappingScript.py" rel="external nofollow noopener" target="_blank">here</a>.</p> <h3 id="prerequisites">Prerequisites:</h3> <ol> <li>RGB or multispectral imagery should be provided by the user with proper understanding on band information and geospatial location information.</li> <li>Specify a directory with an empty folder before this scripts starts exporting all the indices (output images) or processed images.</li> <li>Shapefile (a polygon line drawn over the crop plants) should be provided by the user.</li> </ol> <h3 id="limitation-of-this-algorithm">Limitation of this algorithm:</h3> <ol> <li>Weeds won’t get detected or identified if they are present in-between crop rows.</li> </ol> <h3 id="code-breakdown">Code breakdown</h3> <h3 id="1-importing-packages">1. Importing packages</h3> <p>This section imports various Python packages that are used throughout the script, including numpy, arcpy, rasterio, gdal, matplotlib, and others. These packages provide functionality for working with spatial data, raster manipulation, and plotting.</p> <pre><code class="language-Python">
# This script creates a weed map using several ArcGIS tools and a bit of Image Processing. 
# Original workflow in ArcGIS was developed by Dr. J. Paulo Flores (Assistant Prof. at NDSU)
# Automation using Python scripting was developed by Nitin Rai (PhD Student)
# Agricultural Engineering, Precision Agriculture
# North Dakota State University, USA

#################### Script starts here ########################################################################
################################################################################################################

# Importing packages
import numpy as np
import arcpy # from ArcGIS 
import os
import sys
from arcpy.ia import * # Image Analyst
from arcpy.sa import * # Spatial Analyst
from arcpy import env 
from arcpy.sa import Raster, Float
import rasterio # Working with Raster Dataset
import gdal # Geospatial Data Abstraction Library
import matplotlib.pyplot as plt
</code></pre> <h3 id="2-reading-imagery-from-the-directory">2. Reading imagery from the directory</h3> <p>Here, a raster image file (file_name) is specified, and its bands are extracted using the arcpy.ListRasters() function.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RGB_imagery = r"Your Directory/Sunf_AOI_Lab7_2021.tif"
raster = rasterio.open(RGB_imagery)
bands = [Raster(os.path.join(RGB_imagery, b))
         for b in arcpy.ListRasters()]
</code></pre></div></div> <h3 id="3-band-count-check-in-the-imported-imagery">3. Band count check in the imported imagery</h3> <p>Here the operation is dependent on band count. If the band count is equal to 5 then the script assumes it’s a 5-band imagery and starts calculating all the indices. More indices can be added to the workflow. Whereas, if the band count is greater than 5, then an error message is displayed asking user to enter an imagery which is either 3-band or 5-band. If the band count is equal equal to 3 or 4, then Excess Green is automatically calculated and stored to the HDD. As in array function, the index starts from 0 onwards. For a multispectral imagery (RedEdge MicaSense), 0 = Blue band, 1 = green, 2 = red, 3 = RedEdge, 4 = NIR</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if band_count &gt; 5:
    print("Input Imagery should be 3-band RGB Imagery or 5-band Multispectral Imagery")
elif band_count == 5:
    path = os.path.dirname(imagery)
    base1 = os.path.basename(imagery)
    base = os.path.splitext(base1)[0]
    ndvi_filename = base + "_NDVI.tif"
    ndre_filename = base + "_NDRE.tif"
    savi_filename = base + "_SAVI.tif"
    osavi_filename = base + "_OSAVI.tif"
</code></pre></div></div> <h3 id="4-band-calculation">4. Band calculation</h3> <p>Calculating the number of bands based on the formulae. You can add your own VI and extract information accordingly.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ndvi = (Float(bands[4]) - bands[2]) / (Float(bands[4]) + bands[2]) 
    ndvi.save(ndvi_filename)
    print ("NDVI successfully calculated")
    ndre = (Float(bands[4]) - bands[3]) / (Float(bands[4]) + bands[3]) 
    ndre.save(ndre_filename)
    print ("NDRE successfully calculated")
    savi = 1.5 * ((Float(bands[4]) - bands[2]) / (Float(bands[4]) + bands[2] + 0.5))
    savi.save(savi_filename)
    print ("SAVI successfully calculated")
    osavi = 1.16 * ((Float(bands[4]) - bands[2]) / (Float(bands[4]) + bands[2] + 0.16))
    osavi.save(osavi_filename)
    print ("OSAVI successfully calculated")
else:
    path = os.path.dirname(RGB_imagery)
    base1 = os.path.basename(RGB_imagery)
    base = os.path.splitext(base1)[0]
    ExGreen_filename = base + "_ExcessGreen.tif"
    total_bands = (Float(bands[0] + bands[1] + bands[2]))
    red_band = (Float(bands[2]) / total_bands)
    green_band = (Float(bands[1]) / total_bands)
    blue_band = (Float(bands[0]) / total_bands)
    ExGreen = (2 * green_band - red_band - blue_band)
    ExGreen.save(ExGreen_filename)
    arcpy.env.workspace = path
    print ("You have successfully exported the Excess Green.tif file")
    arcpy.BuildPyramids_management(ExGreen_filename, "", "NONE", "BILINEAR","", "", "")
    print ("Excess Green pyramids successfully calculated")
</code></pre></div></div> <h3 id="5-sharpening-the-image-so-the-objects-crops--weeds-details-are-highlighted">5. Sharpening the image so the objects (crops &amp; weeds) details are highlighted</h3> <p>The Excess Green image is sharpened using convolution, and then a binary raster is created by applying a threshold.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sharpen_ExGreen = arcpy.ia.Convolution(ExGreen, 20)
sharpen_ExGreen.save(r'Your Directory/ExGreen_Sharpened.tif')
print("You have successfully sharpened the Excess Green.tif file!")
# Converting the above sharpened image into binary image, thresholding technique is applied here 
# converting the imagery into 0 and 1.
binary_raster = arcpy.ia.Threshold(sharpen_ExGreen)
binary_raster.save(r"Your Directory/ThresholdSharpen.tif")
print("You have successfully perfromed Imagery Thresholding!")
</code></pre></div></div> <h3 id="6-raster-to-polygon-conversion">6. Raster to Polygon conversion</h3> <p>The binary raster is converted to polygons, where pixels with value 1 become polygons.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inRaster = "ThresholdSharpen.tif"
outPolygons = r"Your Directory/RasterToPolygonConvert.shp"
arcpy.RasterToPolygon_conversion(inRaster, outPolygons, "NO_SIMPLIFY", field)
</code></pre></div></div> <h3 id="7-shapefile-selection-and-buffering">7. Shapefile selection and buffering</h3> <p>Selected features (gridcode &gt; 0) are saved to a new shapefile, and a line shapefile provided by the user is buffered.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>selectedAttributes = arcpy.SelectLayerByAttribute_management(polygonAttached, "NEW_SELECTION", '"gridcode" &gt; 0')
Buffered_CropsLine = arcpy.Buffer_analysis(cropsline, rowsBuffered, distanceField, sideType, endType, dissolve)
</code></pre></div></div> <h3 id="8-polygon-erasing-and-fishnet-creation">8. Polygon erasing and fishnet creation</h3> <p>The script erases features from one polygon layer using another and creates a fishnet grid.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ErasedLayer = r'Your Directory/ErasedPolygonLayerFinal.shp'
arcpy.Erase_analysis(polygon, eraseFeature, ErasedLayer)
outFeatureClass = "fishnet_10x10.shp"
arcpy.CreateFishnet_management(outFeatureClass, origin_coordinate, yAxisCoordinate, CellWidth,
                               CellHeight, numRows, numCols, oppositeCorner,
                               labels, templateExtent, geometryType)
</code></pre></div></div> <h3 id="9-field-addition-and-spatial-selection">9. Field addition and spatial selection</h3> <p>A field is added to the fishnet, and a spatial selection is performed to select features that intersect with the fishnet.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AddedField = arcpy.AddField_management(inFeatures, addfield, "SHORT", fieldPrecision, field_is_nullable="NULLABLE")
LocationSelection = arcpy.SelectLayerByLocation_management(ErasedLayer, 'INTERSECT', outFeatureClass)
</code></pre></div></div> <h3 id="10-copying-selected-features">10. Copying selected features</h3> <p>The selected features are copied to a new shapefile.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arcpy.CopyFeatures_management(LocationSelection, 'IntersectFishnetwithErasedLayer')
</code></pre></div></div> <h3 id="final-output-of-the-developed-weed-prescription-map">Final output of the developed weed prescription map:</h3> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/NR/assets/img/pm-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/NR/assets/img/pm-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/NR/assets/img/pm-1400.webp"></source> <img src="/NR/assets/img/pm.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Sample screenshot of the displayed figure. Green represents corn crops and red represent weeds. </div> <h3 id="credits">Credits:</h3> <ol> <li>Original workflow in ArcGIS Pro was developed by Dr. J. Paulo Flores (Assistant Prof., Department of Ag. &amp; Biosystems Engineering)</li> <li>Automation using Python scripting was developed by Nitin Rai</li> </ol> </article> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> © Copyright 2023 Nitin Rai. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a>, hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>, and tweaked by Nitin Rai. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/NR/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/NR/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/NR/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/NR/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/NR/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/NR/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>